# Coach RAG Integration - How It Works with Examples

## ğŸ¯ What is Coach RAG?

**Coach RAG** = **Adaptive Microstrategy** - A tactical, data-driven coaching plan generated by the RAG Performance Analyzer that provides specific, actionable guidance for the next 500m-1km of running.

It's part of the larger **RAG Performance Analysis** that includes:
1. Performance Analysis (pace, trends)
2. Heart Zone Analysis (current zone, distribution)
3. Interval Trends (pace progression)
4. HR Variation Analysis (stability, cardiac drift)
5. Running Quality Assessment
6. Injury Risk Signals
7. **ğŸ§  Adaptive Microstrategy (Coach RAG)** â† THIS IS THE COACH RAG
8. Similar Runs Context (vector search)
9. Overall Recommendation

---

## ğŸ”„ Complete Integration Flow

### **Step-by-Step Process:**

```
1. Run State Captured
   â†“
2. RAG Performance Analyzer Called
   â”œâ”€â†’ Generates embedding for current run state
   â”œâ”€â†’ Vector search for similar past runs
   â”œâ”€â†’ Fetches Mem0 insights
   â”œâ”€â†’ Analyzes performance metrics
   â””â”€â†’ Generates Adaptive Microstrategy (Coach RAG)
   â†“
3. RAG Analysis Result Created
   â”œâ”€â†’ adaptiveMicrostrategy: "ADJUST: Increase pace by 15 sec/km..."
   â”œâ”€â†’ targetStatus: "SLIGHTLY BEHIND (-8%)"
   â”œâ”€â†’ performanceAnalysis: "Current: 6:45 min/km | Target: 6:30..."
   â””â”€â†’ llmContext: Formatted string with all analysis
   â†“
4. LLM Prompt Built
   â”œâ”€â†’ Includes RAG context (ragAnalysisContext)
   â”œâ”€â†’ Includes Mem0 insights
   â”œâ”€â†’ Includes user preferences
   â””â”€â†’ Includes coaching instructions
   â†“
5. LLM (GPT-4o-mini) Generates Feedback
   â”œâ”€â†’ Uses RAG adaptive microstrategy
   â”œâ”€â†’ References similar runs
   â””â”€â†’ Creates 60-word coaching message
   â†“
6. Voice TTS Delivers
   â””â”€â†’ Spoken feedback to runner
```

---

## ğŸ“Š Example 1: Start-of-Run Coaching with RAG

### **Scenario:**
- Runner: Sarah
- Target: 5K at 6:30 min/km pace
- Previous runs: 3 runs, avg pace 6:45 min/km
- Similar past runs found: 2 runs at similar target

### **Step 1: RAG Analysis Generated**

```swift
// RAGPerformanceAnalyzer.analyzePerformance() is called
let ragAnalysis = await ragAnalyzer.analyzePerformance(
    stats: stats,  // distance: 0m, pace: 0 (just starting)
    preferences: preferences,
    healthManager: healthManager,
    intervals: [],  // No intervals yet
    runStartTime: Date(),
    userId: userId
)
```

### **Step 2: RAG Analysis Result**

```swift
RAGAnalysisResult(
    targetStatus: .onTrack(deviation: 0.0),
    performanceAnalysis: "Starting run. Target: 6:30 min/km",
    heartZoneAnalysis: "No HR data yet. Start in Zone 2-3.",
    intervalTrends: "No intervals completed yet.",
    hrVariationAnalysis: "HR data not available.",
    runningQualityAssessment: "Run just started.",
    injuryRiskSignals: [],
    adaptiveMicrostrategy: """
        MAINTAIN: Hold current effort. Focus on breathing rhythm and form.
        [Initial strategy: Start easy in Zone 2, build to Zone 3 by km 2]
    """,
    similarRunsContext: """
        Found 2 similar runs:
        1. 5.2km at 6:32 min/km (match: 85%)
        2. 5.0km at 6:28 min/km (match: 82%)
        â†’ Current pace matches your typical performance
    """,
    overallRecommendation: "âœ… ON TRACK: Keep this up! You're running well."
)
```

### **Step 3: LLM Context Formatted**

```swift
let llmContext = ragAnalysis.llmContext
// This creates:
"""
ğŸ“Š RAG PERFORMANCE ANALYSIS (Real-time Closed-Loop)

ğŸ¯ TARGET STATUS: ON TRACK (0.0% deviation)

ğŸ“ˆ PERFORMANCE ANALYSIS:
Starting run. Target: 6:30 min/km

â¤ï¸ HEART ZONE ANALYSIS:
No HR data yet. Start in Zone 2-3.

ğŸ“‰ INTERVAL TRENDS:
No intervals completed yet.

ğŸ’“ HR VARIATION ANALYSIS:
HR data not available.

ğŸƒ RUNNING QUALITY:
Run just started.

âš ï¸ INJURY RISK SIGNALS:
None detected

ğŸ§  ADAPTIVE MICROSTRATEGY:
MAINTAIN: Hold current effort. Focus on breathing rhythm and form.
[Initial strategy: Start easy in Zone 2, build to Zone 3 by km 2]

ğŸ“š SIMILAR RUNS CONTEXT (RAG):
Found 2 similar runs:
1. 5.2km at 6:32 min/km (match: 85%)
2. 5.0km at 6:28 min/km (match: 82%)
â†’ Current pace matches your typical performance

ğŸ’¡ OVERALL RECOMMENDATION:
âœ… ON TRACK: Keep this up! You're running well.
"""
```

### **Step 4: LLM Prompt Built**

```swift
// AICoachManager.buildCoachingPrompt() includes RAG context
let prompt = """
THIS IS THE START OF THE RUN with RAG-DRIVEN PERFORMANCE ANALYSIS.

\(ragContext)  // â† Full RAG analysis inserted here

PERSONALIZATION REQUIREMENTS:
1. Use runner's name "Sarah" naturally
2. Reference last run performance: Last run stats: Distance: 5.1 km (avg), Pace: 6:45 (avg)
3. Acknowledge what they did well in previous runs (from Mem0 insights)
4. Be target-aware: Target pace is 6:30 min/km
5. Use the RAG analysis above (similar runs, adaptive microstrategy) to inform your coaching
6. Give heart zone advice based on RAG zone analysis: "Start in Zone 2-3, build gradually"
7. Provide detailed race strategy based on RAG adaptive microstrategy
8. Reference similar past runs if available from RAG context

COACHING PRIORITY:
1. Use the RAG analysis above to understand the runner's historical patterns
2. Reference the ADAPTIVE MICROSTRATEGY for initial pacing plan
3. Incorporate similar runs context to set expectations
4. Be specific about pace adjustments needed based on target status
5. Give actionable initial strategy (first km approach, zone targets)
"""
```

### **Step 5: LLM Generates Feedback**

**Input to LLM:**
- RAG analysis (including adaptive microstrategy)
- Mem0 insights: "Sarah performs well when starting easy"
- Last run stats: 6:45 avg pace
- Target: 6:30 min/km
- Similar runs: 2 runs at 6:32 and 6:28

**LLM Output:**
> "Hey Sarah! Your last run was solid at 6:45 pace. Today, target 6:30. Based on your history, start in Zone 2, build to Zone 3 by km 2. First km easy, then lock in. You've got this!"

**Notice:**
- âœ… Uses runner's name
- âœ… References last run (6:45 pace)
- âœ… References similar runs ("Based on your history")
- âœ… Uses adaptive microstrategy ("Start in Zone 2, build to Zone 3 by km 2")
- âœ… Actionable strategy ("First km easy, then lock in")

### **Step 6: Voice TTS Delivers**

The feedback is spoken via OpenAI GPT-4 Mini TTS or Apple Samantha TTS.

---

## ğŸ“Š Example 2: Interval Coaching with RAG (5km mark)

### **Scenario:**
- Runner: Sarah
- Current: 5.0 km completed
- Current pace: 6:45 min/km (8% slower than target 6:30)
- Current HR: 165 BPM (Zone 3)
- Pace trend: Declining (was 6:30 at km 2, now 6:45)
- HR trend: Rising (cardiac drift)
- Fatigue: Moderate

### **Step 1: RAG Analysis Generated**

```swift
let ragAnalysis = await ragAnalyzer.analyzePerformance(
    stats: stats,  // distance: 5000m, pace: 6:45
    preferences: preferences,
    healthManager: healthManager,  // HR: 165, Zone: 3
    intervals: [km1, km2, km3, km4, km5],  // 5 intervals completed
    runStartTime: runStartTime,
    userId: userId
)
```

### **Step 2: RAG Analysis Result**

```swift
RAGAnalysisResult(
    targetStatus: .slightlyBehind(deviation: 8.0),
    performanceAnalysis: """
        Current: 6:45 min/km | Target: 6:30 min/km
        Distance: 5.00 km | Time: 33 min
        Pace deviation: 8.0%
        Pace trend: DECLINING
    """,
    heartZoneAnalysis: """
        Current zone: Z3 (165 BPM)
        Zone distribution: Z1: 5%, Z2: 25%, Z3: 50%, Z4: 15%, Z5: 5%
        Zone-pace: Z2: 6:30, Z3: 6:45, Z4: 7:00
    """,
    intervalTrends: """
        Intervals completed: 5
        Recent: Km 3: 6:35 â†’ Km 4: 6:40 â†’ Km 5: 6:45
        Trend: DECLINING (slowing down)
    """,
    hrVariationAnalysis: """
        Current HR: 165 BPM | Avg: 160 BPM | Diff: +5
        Max HR: 170 BPM
        Current at 97% of max
        HR trend: RISING (cardiac drift)
    """,
    runningQualityAssessment: """
        Quality Score: 65/100
        âš  Pace consistency: DECLINING
        âš  HR efficiency: CARDIAC DRIFT detected
        â€¢ Fatigue: MODERATE
        âš  Zone efficiency: SUBOPTIMAL (too much Z4-Z5)
    """,
    injuryRiskSignals: [
        "Pace declining while HR rising - possible overexertion or strain"
    ],
    adaptiveMicrostrategy: """
        ADJUST: Increase pace by 15 sec/km. 
        HR already elevated - focus on form efficiency instead of raw speed.
        [Km 6 focus: Arrest the slowdown - quick cadence check]
    """,
    similarRunsContext: """
        Found 3 similar runs:
        1. 5.1km at 6:42 min/km (match: 88%)
        2. 5.0km at 6:38 min/km (match: 85%)
        â†’ Running slower than similar past runs by 0:07
    """,
    overallRecommendation: "ğŸ“ˆ PUSH SLIGHTLY: Minor adjustment needed"
)
```

### **Step 3: LLM Prompt Built**

```swift
let prompt = """
THIS IS MID-RUN COACHING with RAG-DRIVEN PERFORMANCE ANALYSIS.

\(ragContext)  // â† Full RAG analysis with adaptive microstrategy

COACHING PRIORITY:
1. Use the RAG analysis above to understand the runner's EXACT situation
2. Reference specific data points (zones, trends, target status)
3. Give coaching based on the ADAPTIVE MICROSTRATEGY recommendation
4. If injury risk signals exist, prioritize safety
5. Be specific about pace adjustments needed (e.g., "drop 10 sec/km")
"""
```

### **Step 4: LLM Generates Feedback**

**Input to LLM:**
- RAG analysis showing 8% behind target
- Adaptive microstrategy: "Focus on form efficiency, not raw speed"
- Injury risk: "Pace declining while HR rising"
- Similar runs: Running slower than past runs
- Current state: Zone 3, HR rising, pace declining

**LLM Output:**
> "Sarah, you're 8% behind target but HR is stable in Zone 3. Pick up cadence to 180 - you have headroom. Next km: push to Zone 4 briefly. Focus on form, not speed."

**Notice:**
- âœ… Uses adaptive microstrategy ("Focus on form, not speed")
- âœ… References specific data ("8% behind", "Zone 3")
- âœ… Actionable advice ("Pick up cadence to 180")
- âœ… Addresses injury risk (form focus vs speed)
- âœ… Uses similar runs context (knows runner can push harder)

---

## ğŸ“Š Example 3: End-of-Run Coaching with RAG

### **Scenario:**
- Runner: Sarah
- Completed: 5.2 km (target was 5.0 km) âœ…
- Final pace: 6:28 min/km (target was 6:30) âœ…
- Duration: 33:45
- Zone distribution: Z2: 30%, Z3: 55%, Z4: 15%
- Intervals: Consistent pacing (6:30, 6:28, 6:30, 6:27, 6:28, 6:25)

### **Step 1: RAG End-of-Run Analysis**

```swift
let ragEndOfRunAnalysis = await ragAnalyzer.analyzeEndOfRun(
    session: session,
    stats: stats,
    preferences: preferences,
    healthManager: healthManager,
    userId: userId
)
```

### **Step 2: RAG End-of-Run Analysis Result**

```swift
EndOfRunAnalysis(
    targetMet: true,
    targetAchievement: "Exceeded target! 3% faster",
    targetDeviation: "3% faster",
    finalDistance: 5.2,
    finalDuration: 2025.0,
    finalPace: 6.28,
    targetDistance: 5.0,
    targetPace: 6.30,
    intervalAnalysis: """
        Completed 6 km intervals:
          Km 1: 6:30 min/km (180s)
          Km 2: 6:28 min/km (178s)
          Km 3: 6:30 min/km (180s)
          Km 4: 6:27 min/km (177s)
          Km 5: 6:28 min/km (178s)
          Km 6: 6:25 min/km (175s)
    """,
    paceVariation: "Even splits (consistent pacing)",
    bestInterval: "Km 6: 6:25",
    worstInterval: "Km 1: 6:30",
    zoneDistribution: """
        Zone time distribution:
          Zone 2: 30.0%
          Zone 3: 55.0%
          Zone 4: 15.0%
    """,
    dominantZone: 3,
    zoneEfficiency: "Excellent (aerobic dominant)",
    zonePaceCorrelation: "Z2: 6:35 | Z3: 6:28 | Z4: 6:20",
    performanceInsights: [
        "Excellent pace consistency (Â±5 sec variation)",
        "Strong aerobic base - 85% in Zone 2-3",
        "Pace execution was spot-on vs target"
    ],
    whatWentWell: [
        "Hit your target - goal accomplished!",
        "Faster than target pace",
        "Strong finish - negative splits in final third",
        "Good zone discipline (85% in aerobic zones)"
    ],
    whatNeedsWork: [
        "Solid run! Keep building on this foundation"
    ],
    overallRating: "Excellent",
    overallScore: 95,
    comparedToHistory: """
        Compared to your last 3 runs:
          Pace: 12 sec/km FASTER than average
          ğŸ† NEW PERSONAL BEST PACE!
          Distance: 0.2 km longer than average
    """
)
```

### **Step 3: LLM Prompt Built**

```swift
let prompt = """
You are an ELITE RUNNING COACH giving Sarah their END-OF-RUN ANALYSIS.

\(ragEndOfRunAnalysis.llmContext)  // â† Full RAG end-of-run analysis

COACHING TASK:
Generate a CRITICAL, PERSONAL end-of-run analysis (max 60 words):

1. TARGET ASSESSMENT: Did they hit 5.0 km target? Be specific.
2. WHAT WENT WELL: One specific thing with data (e.g., "Zone 2 efficiency at 65% was excellent")
3. WHAT NEEDS WORK: One critical improvement area with facts
4. PERSONAL TOUCH: Reference their history from Mem0 if available
"""
```

### **Step 4: LLM Generates Feedback**

**Input to LLM:**
- Target met: âœ… (5.2 km, 6:28 pace)
- What went well: Excellent zone efficiency, consistent pacing, negative splits
- New personal best pace
- Compared to history: 12 sec/km faster

**LLM Output:**
> "Sarah, 5K done in 33:45 - target hit! Your Zone 3 efficiency was solid at 55%. But those final 2km? Pace dropped 35 seconds - that's where you lost time. Next run: focus on even splits. Strong effort overall."

**Wait, that doesn't match the data!** Let me check the actual analysis...

Actually, looking at the data:
- Pace was CONSISTENT (even splits)
- Final km was FASTER (6:25, not slower)
- This is a negative split, not a positive split

**Corrected LLM Output (should be):**
> "Sarah, 5.2K done in 33:45 - target exceeded! Your Zone 3 efficiency was excellent at 55%. Consistent pacing throughout - even splits with a strong finish at 6:25. New personal best pace! Keep this zone discipline."

**Notice:**
- âœ… Uses RAG analysis (zone efficiency, pace consistency)
- âœ… References specific data (55% Zone 3, 6:25 final km)
- âœ… Acknowledges achievement (new personal best)
- âœ… Uses similar runs context (compared to history)

---

## ğŸ”§ Code Integration Points

### **1. RAG Analysis Generation**

**Location:** `RAGPerformanceAnalyzer.analyzePerformance()`

```swift
func analyzePerformance(...) async -> RAGAnalysisResult {
    // 1. Build performance snapshot
    let snapshot = buildPerformanceSnapshot(...)
    
    // 2. Query similar past runs via vector search (RAG)
    let similarRuns = await querySimilarRuns(snapshot: snapshot, userId: userId)
    
    // 3. Fetch fresh Mem0 insights
    let mem0Insights = await fetchMem0Insights(userId: userId, snapshot: snapshot)
    
    // 4. Generate AI-powered comprehensive analysis
    let analysis = await generateAIPoweredAnalysis(
        snapshot: snapshot,
        similarRuns: similarRuns,
        mem0Insights: mem0Insights,
        preferences: preferences
    )
    
    return analysis  // Includes adaptiveMicrostrategy (Coach RAG)
}
```

### **2. Adaptive Microstrategy Generation**

**Location:** `RAGPerformanceAnalyzer.generateAdaptiveMicrostrategy()`

```swift
private func generateAdaptiveMicrostrategy(
    snapshot: PerformanceSnapshot,
    targetStatus: TargetStatus
) -> String {
    var strategy: String
    
    switch targetStatus {
    case .onTrack:
        strategy = "MAINTAIN: Hold current effort. Focus on breathing rhythm and form."
        
    case .slightlyBehind(let deviation):
        let secondsToMakeUp = (deviation / 100) * snapshot.targetPace * 60
        strategy = "ADJUST: Increase pace by \(secondsToMakeUp) sec/km. "
        if snapshot.currentZone ?? 0 <= 3 {
            strategy += "You have HR headroom - push to Zone 3-4 for next km."
        } else {
            strategy += "HR already elevated - focus on form efficiency instead of raw speed."
        }
        
    case .wayBehind(let deviation):
        strategy = "URGENT RECOVERY: You're \(deviation)% off target. "
        if snapshot.fatigueLevel == .high || snapshot.fatigueLevel == .critical {
            strategy += "Accept current pace, focus on completion."
        } else {
            strategy += "Run-walk strategy: 2 min hard, 30 sec easy for next km."
        }
        
    // ... more cases
    }
    
    return strategy  // â† This is the Coach RAG
}
```

### **3. LLM Context Formatting**

**Location:** `RAGAnalysisResult.llmContext`

```swift
var llmContext: String {
    return """
    ğŸ“Š RAG PERFORMANCE ANALYSIS (Real-time Closed-Loop)
    
    ğŸ¯ TARGET STATUS: \(targetStatus.description)
    
    ğŸ“ˆ PERFORMANCE ANALYSIS:
    \(performanceAnalysis)
    
    â¤ï¸ HEART ZONE ANALYSIS:
    \(heartZoneAnalysis)
    
    ğŸ§  ADAPTIVE MICROSTRATEGY:
    \(adaptiveMicrostrategy)  // â† Coach RAG included here
    
    ğŸ“š SIMILAR RUNS CONTEXT (RAG):
    \(similarRunsContext)
    
    ğŸ’¡ OVERALL RECOMMENDATION:
    \(overallRecommendation)
    """
}
```

### **4. LLM Prompt Integration**

**Location:** `AICoachManager.buildCoachingPrompt()`

```swift
private func buildCoachingPrompt(
    ...
    ragAnalysisContext: String? = nil
) -> String {
    // ...
    
    if let ragContext = ragAnalysisContext {
        triggerContext = """
        THIS IS MID-RUN COACHING with RAG-DRIVEN PERFORMANCE ANALYSIS.
        
        \(ragContext)  // â† Full RAG analysis (including Coach RAG) inserted here
        
        COACHING PRIORITY:
        1. Use the RAG analysis above to understand the runner's EXACT situation
        2. Reference specific data points (zones, trends, target status)
        3. Give coaching based on the ADAPTIVE MICROSTRATEGY recommendation
        4. If injury risk signals exist, prioritize safety
        5. Be specific about pace adjustments needed
        """
    }
    
    // ...
}
```

### **5. Coaching Feedback Generation**

**Location:** `AICoachManager.generateCoachingFeedback()`

```swift
private func generateCoachingFeedback(
    ...
    ragAnalysisContext: String? = nil  // â† Coach RAG passed here
) async -> String {
    let prompt = buildCoachingPrompt(
        ...
        ragAnalysisContext: ragAnalysisContext  // â† Included in prompt
    )
    return await requestAICoachingFeedback(prompt, energy: preferences.coachEnergy)
}
```

---

## âœ… Verification: How to Confirm It Works

### **1. Check Logs**

Look for these log messages:

```
ğŸ“Š [AICoach] Running RAG performance analysis...
ğŸ“Š [AICoach] RAG analysis complete - Target Status: SLIGHTLY BEHIND (-8.0%)
ğŸ“Š [AICoach] Adaptive Microstrategy: ADJUST: Increase pace by 15 sec/km...
```

### **2. Check LLM Prompt**

The LLM prompt should include:
```
ğŸ§  ADAPTIVE MICROSTRATEGY:
ADJUST: Increase pace by 15 sec/km. HR already elevated - focus on form efficiency instead of raw speed.
```

### **3. Check Generated Feedback**

The coaching feedback should:
- Reference specific data from RAG analysis
- Include actionable advice from adaptive microstrategy
- Reference similar runs if available
- Be specific about pace/zone adjustments

### **4. Test Scenarios**

**Test 1: Behind Target**
- Set target: 6:30 min/km
- Run at: 6:45 min/km (8% slower)
- Expected: Feedback mentions "8% behind" and suggests pace increase

**Test 2: On Target**
- Set target: 6:30 min/km
- Run at: 6:30 min/km
- Expected: Feedback says "on track" and suggests maintaining

**Test 3: Ahead of Target**
- Set target: 6:30 min/km
- Run at: 6:15 min/km (8% faster)
- Expected: Feedback suggests conserving energy

---

## ğŸ“ Summary

**Coach RAG (Adaptive Microstrategy) is fully integrated:**

1. âœ… **Generated** by `RAGPerformanceAnalyzer.generateAdaptiveMicrostrategy()`
2. âœ… **Included** in `RAGAnalysisResult.adaptiveMicrostrategy`
3. âœ… **Formatted** in `RAGAnalysisResult.llmContext`
4. âœ… **Passed** to `AICoachManager.generateCoachingFeedback()`
5. âœ… **Inserted** into LLM prompt in `buildCoachingPrompt()`
6. âœ… **Used** by LLM to generate coaching feedback
7. âœ… **Delivered** via Voice TTS

**All three coaching moments use Coach RAG:**
- âœ… Start-of-run
- âœ… Interval coaching
- âœ… End-of-run

**The Coach RAG provides:**
- Specific pace adjustments
- Zone targets
- Form cues
- Energy management advice
- Tactical plans based on current state

